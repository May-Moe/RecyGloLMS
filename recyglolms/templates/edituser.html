<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/CSS/style.css">
    <link rel="stylesheet" href="../static/CSS/EditUser.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Edit User</title>
</head>
<body>
    <div class="dashboard">
        <nav class="navbar">
            <button id="toggle-button" class="toggle-button">
                <span class="icon">&#9776;</span>
            </button>
            <div class="profile-right">
                <img src="../static/img/Recyglo logo.png" alt="Logo" class="logo" style="width: 110px;">
                <!-- Language Selector -->
            <div class="language-dropdown">
                <button class="language-btn">
                <img src="../static/img/uk.svg" class="flag-icon"> English <i class="fas fa-chevron-down icon"></i>
                </button>
            <div class="dropdown-content">
                <a href="?lang=en"><img src="../static/img/uk.svg" class="flag-icon"> English</a>
                <a href="?lang=th"><img src="../static/img/th.svg" class="flag-icon"> Thailand</a>
                <a href="?lang=my"><img src="../static/img/my.svg" class="flag-icon"> Myanmar</a>
                <a href="?lang=vi"><img src="../static/img/vi.svg" class="flag-icon"> Vietnam</a>
                <a href="?lang=in"><img src="../static/img/id.svg" class="flag-icon"> Indonia</a>
                <a href="?lang=ko"><img src="../static/img/kr.svg" class="flag-icon"> Korea</a>
                
            </div>
            </div>
                <button class="notification-button" id="notification-button">
                    <i class="fas fa-bell"></i>
                    <span id="notification-count" class="notification-count">0</span>
                </button>

                <div id="notification-dropdown" class="notification-dropdown hidden">
                    <ul id="notification-list">
                        <li>New course available: "Recycling 101"</li>
                        <li>Your activity submission is pending review.</li>
                    </ul>
                </div>
                <div class="dropdown">
                    
                    <img src="../static/img/profile.webp" alt="Profile" id="profile-pic-right" class="profile-pic" onclick="toggleDropdown()">
                    <div id="profile-dropdown" class="dropdown-menu hidden">
                        <h4 class="profile-header">Hello, <span id="user-name">{{ current_user_name }}</span></h4>
                        <p id="profile-email">{{ current_user_email }}</p>
                        <a href="{{ url_for('auth.logout') }}" id="logout-button">Logout</a>
                    </div>
                </div>
            </div>
        </nav>
        <nav class="sidebar">
            <div class="logo" style="text-align: left;">
                <img src="../static/img/Recyglo logo.png" alt="Logo" id="sidebar-logo" style="width: 140px;">
            </div>
            <ul>
                <li><a href="{{ url_for('admin.admin_home') }}"><i class="fa-solid fa-house icon"></i> Home</a></li>
                <li><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt icon"></i> Dashboard</a></li>
                <li><a href="{{ url_for('admin.Activities') }}"><i class="fas fa-tasks icon"></i> Activity</a></li>
                <li><a href="{{ url_for('announcement.view_all_announcements') }}"><i class="fas fa-bullhorn icon"></i> Announcement</a></li>
                <!-- Dropdown Class Management -->
                <li class="dropdown-class">
                    <span style="display: flex; align-items: center; margin-left: 4px; padding: 10px 0px;">
                        <i class="fa-solid fa-chalkboard icon"></i> 
                        <span style="margin-left: 9px; font-size: 14px;">Class Management</span>
                    </span>
                    <i class="fa fa-caret-down icon"></i>
                </li>
                
                <div class="dropdown-container-class">
                    <ul>
                    <li><a href="{{ url_for('manage_classes') }}"><i class="fa-solid fa-chalkboard-user icon"></i> Classes</a></li>
                    <li><a href="{{ url_for('admin.manage_course') }}"><i class="fa-solid fa-book-open icon"></i> Courses</a></li>
                </ul>
                </div>

                <li><a href="{{ url_for('upload.view_files') }}"><i class="fas fa-upload icon"></i> Upload</a></li>

                <!-- dropdown user management -->
                <li class="dropdown-user">
                    <span style="display: flex; align-items: center; margin-left: 4px; padding: 10px 0px;">
                        <i class="fas fa-user icon"></i> 
                        <span style="margin-left: 9px; font-size: 14px;">User Management</span>
                    </span>
                    <i class="fa fa-caret-down icon"></i>
                </li>
                
                <div class="dropdown-container">
                    <ul>
                    <li><a href="{{ url_for('admin.view_users') }}"><i class="fas fa-user icon"></i> View All Users</a></li>
                    <li><a href="{{ url_for('admin.user_levels') }}"><i class="fa-solid fa-users-gear icon"></i> Users Roles</a></li>
                    <li><a href="{{ url_for('admin.Alumni_admin') }}"><i class="fa-solid fa-user-group icon"></i> Alumni</a></li>
                    <li><a href="{{ url_for('admin.view_all_progress') }}"><i class="fa-solid fa-bars-progress icon"></i> Progress</a></li>
                </ul>
                </div>
                <li><a href="{{ url_for('quiz.view_all_quizzes') }}"><i class="fa-solid fa-lightbulb icon"></i> Quiz</a></li>
                <li><a href="{{ url_for('admin.show_logs') }}" class="active"><i class="fa-solid fa-database icon"></i> Action Logs</a></li>
            </ul>
        </nav>
        <div class="container">
            <a href="{{ url_for('admin.view_users') }}" class="back-icon"><i class="fa-solid fa-angle-left"></i></i></a>
            <h2>User Edit</h2>
            <form id="editProfileForm" action="{{ url_for('admin.edit_user', user_id=user.userid) }}" method="POST">
                <div class="form-group">
                    <label for="name">Username</label>
                    <input type="text" id="name" name="name" value="{{ user.name }}" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="example@gmail.com" value="{{ user.email }}" required>
                </div>
            
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" name="role">
                        <option value="0" {% if user.role == 0 %}selected{% endif %}>User</option>
                        <option value="1" {% if user.role == 1 %}selected{% endif %}>Admin</option>
                        <option value="2" {% if user.role == 2 %}selected{% endif %}>Sub-Admin</option>
                    </select>
                </div>
            
                <!-- Change Password Button -->
                <button type="button" class="change-password-button" onclick="askForAdminPassword()">Change Password</button>
            
                <!-- Admin password field -->
                <div class="form-group" id="admin-password-group" style="display: none; margin: 18px 10px;">
                    <label for="admin_password">Your Admin Password (Required for Changing User Password)</label>
                    <input type="password" id="admin_password" name="admin_password" required>
                    <button type="button" class="verify-password-button" onclick="verifyAdminPassword()">Verify</button>
                </div>
            
                <!-- New Password field, initially hidden -->
                <div class="form-group" id="new-password-group" style="display: none;">
                    <label for="password">New Password</label>
                    <input type="password" id="password" name="password">
                </div>
            
                <div class="buttons">
                    <button type="submit" class="submit-button" id="submit-button" style="display: none;">Save Changes</button>
                    <button type="button" class="cancel-button" onclick="cancelEdit()">Cancel</button>
                </div>
            </form>
            
            <script>
                // Show the admin password field when the "Change Password" button is clicked
                function askForAdminPassword() {
                    document.getElementById('admin-password-group').style.display = 'block';
                    document.getElementById('new-password-group').style.display = 'none'; // Hide the new password field initially
                    document.getElementById('submit-button').style.display = 'none'; // Hide the submit button
                }
            
                // Verify the admin password
                function verifyAdminPassword() {
                    const adminPassword = document.getElementById('admin_password').value.trim();
            
                    if (adminPassword === "") {
                        alert("Please enter your admin password.");
                        return;
                    }
            
                    // Send the admin password to the backend for verification using a simple form submission.
                    const form = document.getElementById('editProfileForm');
                    const adminPasswordInput = document.createElement('input');
                    adminPasswordInput.type = 'hidden';
                    adminPasswordInput.name = 'admin_password';
                    adminPasswordInput.value = adminPassword;
                    form.appendChild(adminPasswordInput);
            
                    // Add a flag to indicate password verification is requested
                    const verifyPasswordFlag = document.createElement('input');
                    verifyPasswordFlag.type = 'hidden';
                    verifyPasswordFlag.name = 'verify_password';
                    verifyPasswordFlag.value = 'true';
                    form.appendChild(verifyPasswordFlag);
            
                    // Only verify admin password, do not submit yet
                    fetch("{{ url_for('admin.edit_user', user_id=user.userid) }}", {
                        method: "POST",
                        body: new FormData(form)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Password verified, show new password field and the submit button
                            document.getElementById('new-password-group').style.display = 'block';
                            document.getElementById('submit-button').style.display = 'block'; // Show submit button
                        } else {
                            alert("Admin password is incorrect!");
                            document.getElementById('admin-password-group').style.display = 'none'; // Hide admin password field
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying admin password:', error);
                    });
                }
            </script>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById('editProfileForm');
            const submitButton = document.getElementById('submit-button');
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const roleInput = document.getElementById('role');
            const passwordInput = document.getElementById('password');
            const adminPasswordGroup = document.getElementById('admin-password-group');
            const newPasswordGroup = document.getElementById('new-password-group');
    
            // Get original values (stored as data attributes)
            const originalName = form.dataset.originalName;
            const originalEmail = form.dataset.originalEmail;
            const originalRole = form.dataset.originalRole;
    
            // Function to check if any field has changed
            function checkForChanges() {
                if (
                    nameInput.value.trim() !== originalName ||
                    emailInput.value.trim() !== originalEmail ||
                    roleInput.value !== originalRole ||
                    passwordInput.value.trim() !== ""
                ) {
                    submitButton.style.display = "block"; // Show the "Save Changes" button
                } else {
                    submitButton.style.display = "none"; // Hide if no changes
                }
            }
    
            // Add event listeners to fields to detect changes
            nameInput.addEventListener("input", checkForChanges);
            emailInput.addEventListener("input", checkForChanges);
            roleInput.addEventListener("change", checkForChanges);
            passwordInput.addEventListener("input", checkForChanges);
    
            // Show admin password field only when changing password
            function askForAdminPassword() {
                adminPasswordGroup.style.display = 'block';
                newPasswordGroup.style.display = 'none'; // Hide new password field initially
                submitButton.style.display = 'none'; // Hide submit button until verified
            }
    
            // Verify admin password before allowing password change
            function verifyAdminPassword() {
                const adminPassword = document.getElementById('admin_password').value.trim();
    
                if (adminPassword === "") {
                    alert("Please enter your admin password.");
                    return;
                }
    
                const formData = new FormData();
                formData.append("admin_password", adminPassword);
                formData.append("verify_password", "true");
    
                fetch("{{ url_for('admin.edit_user', user_id=user.userid) }}", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        newPasswordGroup.style.display = 'block'; // Show password field
                        submitButton.style.display = 'block'; // Show submit button
                    } else {
                        alert("Admin password is incorrect!");
                        adminPasswordGroup.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error verifying admin password:', error);
                    alert("An error occurred while verifying the password. Please try again.");
                });
            }
    
            // Prepare form submission (only send changed fields)
            function prepareFormSubmission() {
                const formData = new FormData();
    
                // Only add changed fields
                if (nameInput.value.trim() !== originalName) formData.append("name", nameInput.value.trim());
                if (emailInput.value.trim() !== originalEmail) formData.append("email", emailInput.value.trim());
                if (roleInput.value !== originalRole) formData.append("role", roleInput.value);
                if (passwordInput.value.trim()) formData.append("password", passwordInput.value.trim()); // Only send if changed
    
                if (formData.keys().next().done) {
                    alert("No changes detected.");
                    return;
                }
    
                fetch("{{ url_for('admin.edit_user', user_id=user.userid) }}", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.text())
                .then(() => {
                    alert("User updated successfully!");
                    window.location.reload();
                })
                .catch(error => {
                    console.error("Error updating user:", error);
                    alert("An error occurred. Please try again.");
                });
            }
    
            // Attach event listener to the submit button
            submitButton.addEventListener("click", function (event) {
                event.preventDefault();
                prepareFormSubmission();
            });
        });
    </script>    
    
        </div>
    </div>
    <script src="../static/JS/script.js"></script>
    
</body>
</html>