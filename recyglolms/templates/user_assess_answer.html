<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Assessment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .questions-container {
            display: none;
        }
        .question-image {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <button id="start-btn" class="btn btn-primary">Start Assessment</button>

        <div id="assessment-container" class="questions-container">
            <p>Question {{ question_index + 1 }} / {{ total_questions }}</p>
            <p id="timer">Time Left: <span id="time-left"></span></p>

            <form id="answer-form" method="POST" action="{{ url_for('assessment.submit_answer', assessment_id=assessment_id, question_index=question_index) }}">
                <div class="question-item">
                    <h4>Question {{ question_index + 1 }} / {{ total_questions }}</h4>
                    <p>{{ question.question }}</p>

                    {% if question.image_url %}
                        <img src="{{ question.image_url }}" alt="Question Image" class="question-image">
                    {% endif %}

                    <textarea id="answer-text" name="answer_text" placeholder="Type your answer here..." required></textarea>
                    <input type="hidden" name="question_id" value="{{ question.id }}">
                </div>

                {% if question_index > 0 %}
                    <a href="{{ url_for('assessment.submit_answer', assessment_id=assessment_id, question_index=question_index - 1) }}" class="btn btn-secondary mt-3">Previous</a>
                {% endif %}
                
                {% if question_index + 1 < total_questions %}
                    <button type="submit" class="btn btn-primary mt-3">Next</button>
                {% else %}
                    <button type="submit" id="submit-btn" class="btn btn-success mt-3">Submit All Answers</button>
                {% endif %}
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const startBtn = document.getElementById("start-btn");
            const assessmentContainer = document.getElementById("assessment-container");
            const answerInput = document.getElementById("answer-text");
            const timerDisplay = document.getElementById("time-left");
            const form = document.getElementById("answer-form");
            const submitBtn = document.getElementById("submit-btn");
    
            const questionIndex = {{ question_index }};
            const assessmentId = {{ assessment_id }};
            const totalTime = {{ time_limit | default(10) }} * 60; // Convert minutes to seconds
    
            // Restore previous answer if available
            const savedAnswer = sessionStorage.getItem(`answer_${assessmentId}_${questionIndex}`);
            if (savedAnswer) {
                answerInput.value = savedAnswer;
            }
    
            answerInput.addEventListener("input", function () {
                sessionStorage.setItem(`answer_${assessmentId}_${questionIndex}`, answerInput.value);
            });
    
            // Handle assessment start
            if (localStorage.getItem("assessmentStarted") === "true") {
                startBtn.style.display = "none";
                assessmentContainer.style.display = "block";
                startTimer();
            }
    
            startBtn.addEventListener("click", function () {
                startBtn.style.display = "none";
                assessmentContainer.style.display = "block";
                localStorage.setItem("assessmentStarted", "true");
                startTimer();
            });
    
            function startTimer() {
                let timeLeft = localStorage.getItem("timeRemaining") ? parseInt(localStorage.getItem("timeRemaining")) : totalTime;
                
                function updateTimer() {
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById("submit-btn").click();
                    } else {
                        let minutes = Math.floor(timeLeft / 60);
                        let seconds = timeLeft % 60;
                        timerDisplay.innerText = `${minutes}m ${seconds}s`;
                        localStorage.setItem("timeRemaining", timeLeft);
                        timeLeft--;
                    }
                }
    
                updateTimer();
                var timerInterval = setInterval(updateTimer, 1000);
            }
    
            // âœ… Clear Storage on Final Submit
            if (submitBtn) {
                submitBtn.addEventListener("click", function () {
                    localStorage.removeItem("assessmentStarted");
                    localStorage.removeItem("timeRemaining");
                    sessionStorage.clear();
                });
            }
    
        });
    </script>
    
</body>
</html>
